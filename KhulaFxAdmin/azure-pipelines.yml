trigger:
  - master
  - main

pool:
  name: Default

variables:
  - group: Deployment-Secrets

stages:
  - stage: Build
    jobs:
      - job: BuildJob
        steps:
          - checkout: self

          - task: UseDotNet@2
            inputs:
              version: 8.x

          - task: DotNetCoreCLI@2
            inputs:
              command: build
              projects: KhulaFxAdmin/KhulaFxAdmin.csproj
              arguments: --configuration Release

          - task: DotNetCoreCLI@2
            inputs:
              command: publish
              projects: KhulaFxAdmin/KhulaFxAdmin.csproj
              arguments: --configuration Release --output $(Build.ArtifactStagingDirectory)

          - task: PublishBuildArtifacts@1
            inputs:
              pathToPublish: $(Build.ArtifactStagingDirectory)
              artifactName: backend

  - stage: Deploy
    dependsOn: Build
    jobs:
      - job: DeployJob
        steps:
          - download: current
            artifact: backend

          - task: PowerShell@2
            displayName: Deploy to IIS
            inputs:
              targetType: inline
              script: |
                $src = "$(Pipeline.Workspace)/backend"
                $vps = "$(vpsServer)"
                $dst = "\\$vps\c$\inetpub\wwwroot\khulafx.com\api"
                
                Write-Host "Stopping IIS..." -ForegroundColor Yellow
                Invoke-Command -ComputerName $vps -ScriptBlock {
                  net stop W3SVC
                  Start-Sleep -Seconds 2
                }
                
                Write-Host "Clearing old files..." -ForegroundColor Yellow
                Get-ChildItem -Path $dst -Force -ErrorAction Continue | Where-Object { $_.Name -ne "web.config" } | ForEach-Object {
                  Remove-Item -Path $_.FullName -Recurse -Force -ErrorAction SilentlyContinue
                  Write-Host "  Deleted: $($_.Name)"
                }
                
                Write-Host "Copying new files..." -ForegroundColor Yellow
                Get-ChildItem -Path $src -Force | ForEach-Object {
                  Copy-Item -Path $_.FullName -Destination $dst -Recurse -Force -ErrorAction SilentlyContinue
                  Write-Host "  Copied: $($_.Name)" -ForegroundColor Green
                }
                
                Write-Host "Starting IIS..." -ForegroundColor Yellow
                Invoke-Command -ComputerName $vps -ScriptBlock {
                  net start W3SVC
                  Start-Sleep -Seconds 3
                }
                
                Write-Host "Deployment complete" -ForegroundColor Green