trigger:
  - master
  - main

pool:
  name: Default

variables:
  - group: Deployment-Secrets

stages:
  - stage: Build
    jobs:
      - job: BuildJob
        steps:
          - checkout: self

          - task: UseDotNet@2
            displayName: Install .NET 8
            inputs:
              version: 8.x

          - task: DotNetCoreCLI@2
            displayName: Build Release
            inputs:
              command: build
              projects: KhulaFxAdmin/KhulaFxAdmin.csproj
              arguments: --configuration Release

          - task: DotNetCoreCLI@2
            displayName: Publish Release
            inputs:
              command: publish
              projects: KhulaFxAdmin/KhulaFxAdmin.csproj
              arguments: --configuration Release --output $(Build.ArtifactStagingDirectory)

          - task: PublishBuildArtifacts@1
            displayName: Publish Artifacts
            inputs:
              pathToPublish: $(Build.ArtifactStagingDirectory)
              artifactName: backend

  - stage: Deploy
    displayName: Deploy to VPS
    dependsOn: Build
    jobs:
      - job: DeployJob
        displayName: Deploy Backend
        steps:
          - download: current
            artifact: backend

          - task: PowerShell@2
            displayName: Deploy to IIS
            inputs:
              targetType: inline
              script: |
                $src = "$(Pipeline.Workspace)/backend"
                $vps = "$(vpsServer)"
                $dst = "\\$vps\c$\inetpub\wwwroot\khulafx.com\api"
                $username = "$(deployUser)"
                $password = "$(DEPLOY_PASSWORD)"
                
                Write-Host "========================================" -ForegroundColor Cyan
                Write-Host "Deploying Backend" -ForegroundColor Cyan
                Write-Host "========================================" -ForegroundColor Cyan
                Write-Host "Source: $src" -ForegroundColor White
                Write-Host "VPS: $vps" -ForegroundColor White
                Write-Host "Destination: $dst" -ForegroundColor White
                Write-Host ""
                
                Write-Host "Step 1: Authenticating with VPS..." -ForegroundColor Yellow
                try {
                  net use "\\$vps\c$" /user:"$username" "$password" /persistent:no 2>&1 | Out-Null
                  Write-Host "✅ Network share authenticated" -ForegroundColor Green
                } catch {
                  Write-Host "❌ Authentication failed: $_" -ForegroundColor Red
                  exit 1
                }
                
                Write-Host "`nStep 2: Stopping IIS..." -ForegroundColor Yellow
                try {
                  $session = New-PSSession -ComputerName $vps -Credential (New-Object System.Management.Automation.PSCredential($username, (ConvertTo-SecureString $password -AsPlainText -Force))) -ErrorAction Stop
                  Invoke-Command -Session $session -ScriptBlock {
                    net stop W3SVC
                    Start-Sleep -Seconds 5
                  }
                  Remove-PSSession $session
                  Write-Host "✅ IIS stopped" -ForegroundColor Green
                } catch {
                  Write-Host "⚠️ Could not stop IIS via PSRemoting, continuing..." -ForegroundColor Yellow
                }
                
                Write-Host "`nStep 3: Waiting for file locks to release..." -ForegroundColor Yellow
                Start-Sleep -Seconds 5
                
                Write-Host "`nStep 4: Deploying files with Robocopy..." -ForegroundColor Yellow
                robocopy $src $dst /E /PURGE /R:10 /W:3 /NFL /NDL /NJH /NJS
                
                $robocopyCode = $LASTEXITCODE
                if ($robocopyCode -le 3) {
                  Write-Host "✅ Files copied (code: $robocopyCode)" -ForegroundColor Green
                } else {
                  Write-Host "❌ Robocopy error code: $robocopyCode" -ForegroundColor Red
                }
                
                Write-Host "`nStep 5: Starting IIS..." -ForegroundColor Yellow
                try {
                  $session = New-PSSession -ComputerName $vps -Credential (New-Object System.Management.Automation.PSCredential($username, (ConvertTo-SecureString $password -AsPlainText -Force))) -ErrorAction Stop
                  Invoke-Command -Session $session -ScriptBlock {
                    net start W3SVC
                    Start-Sleep -Seconds 3
                  }
                  Remove-PSSession $session
                  Write-Host "✅ IIS started" -ForegroundColor Green
                } catch {
                  Write-Host "⚠️ Could not start IIS: $_" -ForegroundColor Yellow
                }
                
                Write-Host ""
                Write-Host "========================================" -ForegroundColor Green
                Write-Host "✅ Deployment Complete!" -ForegroundColor Green
                Write-Host "========================================" -ForegroundColor Green
                Write-Host "API: https://khulafx.com/api" -ForegroundColor Cyan