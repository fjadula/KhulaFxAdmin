trigger:
  - master
  - main

pool:
  name: Default

variables:
  - group: Deployment-Secrets

  # === Configure to match Pipeline A in your Azure DevOps ===
  - name: pipelineAProject
    value: 'KhulaFxTrade'                 # <- update if different
  - name: pipelineAName
    value: 'fjadula.KhulaFxTradeMonitor'  # <- update if different

stages:
  - stage: Build
    displayName: Build
    jobs:
      - job: BuildJob
        displayName: Build KhulaFxAdmin
        steps:
          - checkout: self

          - task: UseDotNet@2
            displayName: Install .NET 8
            inputs:
              version: 8.x

          # ---------------------------
          # Download DLL artifact from Pipeline A
          # ---------------------------
          - task: DownloadPipelineArtifact@2
            displayName: 'Download KhulaFxTradeMonitor DLL (from Pipeline A)'
            inputs:
              project: '$(pipelineAProject)'
              pipeline: '$(pipelineAName)'
              buildType: 'latest'
              artifact: 'KhulaFxTradeMonitorDLL'
              targetPath: '$(Build.SourcesDirectory)/KhulaFxAdmin/Libs'
            # allow pipeline to continue so we can produce a clearer verification error
            continueOnError: true

          # ---------------------------
          # Ensure Libs folder exists
          # ---------------------------
          - task: PowerShell@2
            displayName: Ensure Libs exists
            inputs:
              targetType: inline
              script: |
                $libs = "$(Build.SourcesDirectory)\KhulaFxAdmin\Libs"
                if (!(Test-Path $libs)) {
                  New-Item -ItemType Directory -Path $libs | Out-Null
                  Write-Host "Created: $libs"
                } else {
                  Write-Host "Libs folder exists: $libs"
                }

          # ---------------------------
          # Inject KhulaFxTradeMonitor.dll into KhulaFxAdmin and update csproj
          # ---------------------------
          - task: PowerShell@2
            displayName: Inject DLL and update csproj
            inputs:
              targetType: inline
              script: |
                $dllSource = "$(Build.SourcesDirectory)\KhulaFxAdmin\Libs\KhulaFxTradeMonitor.dll"
                $projectFile = "$(Build.SourcesDirectory)\KhulaFxAdmin\KhulaFxAdmin.csproj"
                $dllTargetDir = "$(Build.SourcesDirectory)\KhulaFxAdmin"

                Write-Host "DLL source: $dllSource"
                Write-Host "Project file: $projectFile"

                if (-Not (Test-Path $projectFile)) {
                  Write-Error "Project file not found: $projectFile"
                  exit 1
                }

                if (-Not (Test-Path $dllSource)) {
                  Write-Warning "KhulaFxTradeMonitor.dll not found at $dllSource"
                  Write-Warning "If Pipeline A published the artifact, check pipeline name/project and artifact name."
                  # Do not exit here - verification step will catch missing DLL and fail
                } else {
                  Copy-Item -Path $dllSource -Destination $dllTargetDir -Force
                  Write-Host "✅ DLL copied to $dllTargetDir"
                }

                # Load csproj XML
                [xml]$csproj = Get-Content $projectFile

                # Check for existing Reference
                $existingRef = $null
                try {
                  $existingRef = $csproj.Project.ItemGroup.Reference | Where-Object { $_.Include -eq "KhulaFxTradeMonitor" }
                } catch {
                  # no Reference node yet
                }

                if (-not $existingRef) {
                  Write-Host "Adding Reference to KhulaFxTradeMonitor.dll in csproj..."
                  $ns = $csproj.Project.NamespaceURI
                  $itemGroup = $csproj.CreateElement("ItemGroup", $ns)
                  $reference = $csproj.CreateElement("Reference", $ns)
                  $reference.SetAttribute("Include", "KhulaFxTradeMonitor")

                  $hintPath = $csproj.CreateElement("HintPath", $ns)
                  $hintPath.InnerText = "KhulaFxTradeMonitor.dll"
                  $reference.AppendChild($hintPath) | Out-Null

                  $privateNode = $csproj.CreateElement("Private", $ns)
                  $privateNode.InnerText = "true"
                  $reference.AppendChild($privateNode) | Out-Null

                  $itemGroup.AppendChild($reference) | Out-Null
                  $csproj.Project.AppendChild($itemGroup) | Out-Null

                  $csproj.Save($projectFile)
                  Write-Host "✅ csproj updated successfully"
                } else {
                  Write-Host "Reference already exists in csproj, skipping injection."
                }

          # ---------------------------
          # Post-injection verification (fail the build if DLL missing or csproj not updated)
          # ---------------------------
          - task: PowerShell@2
            displayName: Post-injection verification
            inputs:
              targetType: inline
              script: |
                $dllPath = "$(Build.SourcesDirectory)\KhulaFxAdmin\KhulaFxTradeMonitor.dll"
                $projectFile = "$(Build.SourcesDirectory)\KhulaFxAdmin\KhulaFxAdmin.csproj"

                Write-Host "Verifying DLL and csproj..."

                $dllExists = Test-Path $dllPath
                if ($dllExists) {
                  Write-Host "✅ DLL found at: $dllPath"
                } else {
                  Write-Error "❌ DLL NOT found at: $dllPath"
                }

                # Check csproj for Reference Include="KhulaFxTradeMonitor"
                if (-Not (Test-Path $projectFile)) {
                  Write-Error "❌ csproj not found at $projectFile"
                  exit 1
                }

                $projContent = Get-Content $projectFile -Raw
                if ($projContent -match '<Reference\s+Include\s*=\s*"KhulaFxTradeMonitor"') {
                  Write-Host "✅ csproj contains Reference to KhulaFxTradeMonitor"
                } else {
                  Write-Error "❌ csproj does NOT contain Reference Include=\"KhulaFxTradeMonitor\""
                }

                # If any previous Write-Error executed, the task will fail and pipeline stops
                if (-not $dllExists) {
                  Write-Error "Verification failed: DLL missing. Aborting build."
                  exit 1
                }

          # ---------------------------
          # Build project
          # ---------------------------
          - task: DotNetCoreCLI@2
            displayName: Build Release
            inputs:
              command: build
              projects: KhulaFxAdmin/KhulaFxAdmin.csproj
              arguments: --configuration Release

          # ---------------------------
          # Publish for deployment
          # ---------------------------
          - task: DotNetCoreCLI@2
            displayName: Publish Release
            inputs:
              command: publish
              projects: KhulaFxAdmin/KhulaFxAdmin.csproj
              arguments: --configuration Release --output $(Build.ArtifactStagingDirectory) -p:PublishSingleFile=false

          - task: PublishBuildArtifacts@1
            displayName: Publish Artifacts
            inputs:
              pathToPublish: $(Build.ArtifactStagingDirectory)
              artifactName: backend

  - stage: Deploy
    displayName: Deploy to VPS
    dependsOn: Build
    jobs:
      - job: DeployJob
        displayName: Deploy Backend
        steps:
          - download: current
            artifact: backend

          - task: PowerShell@2
            displayName: Deploy to IIS
            inputs:
              targetType: inline
              script: |
                $src = "$(Pipeline.Workspace)/backend"
                $vps = "$(vpsServer)"
                $dst = "\\$vps\c$\inetpub\wwwroot\khulafx.com\api"
                $username = "$(deployUser)"
                $password = "$(DEPLOY_PASSWORD)"
                
                Write-Host "========================================" -ForegroundColor Cyan
                Write-Host "Deploying Backend" -ForegroundColor Cyan
                Write-Host "========================================" -ForegroundColor Cyan
                Write-Host "Source: $src" -ForegroundColor White
                Write-Host "VPS: $vps" -ForegroundColor White
                Write-Host "Destination: $dst" -ForegroundColor White
                Write-Host ""
                
                Write-Host "Step 1: Clearing existing connections..." -ForegroundColor Yellow
                net use * /delete /y 2>&1 | Out-Null
                Start-Sleep -Seconds 2
                Write-Host "✅ Connections cleared" -ForegroundColor Green
                
                Write-Host "`nStep 2: Stopping IIS..." -ForegroundColor Yellow
                try {
                  $secPassword = ConvertTo-SecureString $password -AsPlainText -Force
                  $cred = New-Object System.Management.Automation.PSCredential("$vps\$username", $secPassword)
                  $session = New-PSSession -ComputerName $vps -Credential $cred -ErrorAction Stop
                  Invoke-Command -Session $session -ScriptBlock { net stop W3SVC; Start-Sleep -Seconds 5 }
                  Remove-PSSession $session
                  Write-Host "✅ IIS stopped" -ForegroundColor Green
                } catch {
                  Write-Host "⚠️ IIS stop failed, continuing..." -ForegroundColor Yellow
                }
                
                Write-Host "`nStep 3: Waiting for file locks..." -ForegroundColor Yellow
                Start-Sleep -Seconds 5
                
                Write-Host "`nStep 4: Authenticating..." -ForegroundColor Yellow
                net use "\\$vps\c$" /user:"$vps\$username" "$password" /persistent:no
                if ($LASTEXITCODE -eq 0) {
                  Write-Host "✅ Authenticated" -ForegroundColor Green
                } else {
                  Write-Host "❌ Authentication failed" -ForegroundColor Red
                  exit 1
                }
                
                Write-Host "`nStep 5: Clearing old files..." -ForegroundColor Yellow
                Get-ChildItem -Path $dst -Force -ErrorAction Continue | Where-Object { $_.Name -ne "web.config" } | ForEach-Object {
                  Remove-Item -Path $_.FullName -Recurse -Force -ErrorAction SilentlyContinue
                }
                Write-Host "✅ Old files cleared" -ForegroundColor Green
                
                Write-Host "`nStep 6: Copying new files..." -ForegroundColor Yellow
                Get-ChildItem -Path $src -Force | ForEach-Object {
                  Copy-Item -Path $_.FullName -Destination $dst -Recurse -Force -ErrorAction SilentlyContinue
                  Write-Host "  ✅ Copied: $($_.Name)" -ForegroundColor Green
                }
                Write-Host "✅ Files copied" -ForegroundColor Green
                
                Write-Host "`nStep 7: Extracting ZIP if present..." -ForegroundColor Yellow
                $zipFile = "$dst\KhulaFxAdmin.zip"
                if (Test-Path $zipFile) {
                  Write-Host "Found ZIP file, extracting..." -ForegroundColor Cyan
                  Expand-Archive -Path $zipFile -DestinationPath $dst -Force
                  Remove-Item -Path $zipFile -Force
                  Write-Host "✅ ZIP extracted and removed" -ForegroundColor Green
                } else {
                  Write-Host "ℹ️ No ZIP file found" -ForegroundColor Cyan
                }
                
                Write-Host "`nStep 8: Starting IIS..." -ForegroundColor Yellow
                try {
                  $secPassword = ConvertTo-SecureString $password -AsPlainText -Force
                  $cred = New-Object System.Management.Automation.PSCredential("$vps\$username", $secPassword)
                  $session = New-PSSession -ComputerName $vps -Credential $cred -ErrorAction Stop
                  Invoke-Command -Session $session -ScriptBlock { net start W3SVC; Start-Sleep -Seconds 3 }
                  Remove-PSSession $session
                  Write-Host "✅ IIS started" -ForegroundColor Green
                } catch {
                  Write-Host "⚠️ IIS start failed: $_" -ForegroundColor Yellow
                }
                
                Write-Host ""
                Write-Host "========================================" -ForegroundColor Green
                Write-Host "✅ Deployment Complete!" -ForegroundColor Green
                Write-Host "========================================" -ForegroundColor Green
                Write-Host "API: https://khulafx.com/api" -ForegroundColor Cyan
                
                exit 0
