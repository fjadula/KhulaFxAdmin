# Azure Pipeline for KhulaFxAdmin (Backend API)
# Clones KhulaFxTradeMonitor from GitHub, builds it, then builds KhulaFxAdmin
# Deploys to: https://khulafx.com/api

trigger:
  branches:
    include:
      - main
      - master

pool:
  name: 'Default'

variables:
  - group: 'Deployment-Secrets'

stages:
  - stage: Build
    displayName: 'Build Backend API'
    jobs:
      - job: BuildAPI
        displayName: 'Build .NET 8 API'
        steps:
          - checkout: self
            fetchDepth: 1

          - task: UseDotNet@2
            displayName: 'Install .NET 8 SDK'
            inputs:
              version: '8.x'

          - task: PowerShell@2
            displayName: 'Clone KhulaFxTradeMonitor from GitHub'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "Cloning KhulaFxTradeMonitor from GitHub..." -ForegroundColor Cyan
                
                $sourceDir = "$(Build.SourcesDirectory)"
                $tradeMonitorDir = Join-Path $sourceDir "KhulaFxTradeMonitor"
                $githubPat = "$(GITHUB_PAT)"
                
                try {
                  $gitUrl = "https://fjadula:$githubPat@github.com/fjadula/KhulaFxTradeMonitor.git"
                  git clone $gitUrl $tradeMonitorDir
                  Write-Host "✅ Repository cloned successfully" -ForegroundColor Green
                }
                catch {
                  Write-Error "❌ Failed to clone repository: $_"
                  exit 1
                }
                
                if (Test-Path $tradeMonitorDir) {
                  Write-Host "✅ KhulaFxTradeMonitor directory verified" -ForegroundColor Green
                }
                else {
                  Write-Error "❌ KhulaFxTradeMonitor directory not found"
                  exit 1
                }

          - task: DotNetCoreCLI@2
            displayName: 'Build KhulaFxTradeMonitor'
            inputs:
              command: 'build'
              projects: '$(Build.SourcesDirectory)/KhulaFxTradeMonitor/**/*.csproj'
              arguments: '--configuration Release'

          - task: PowerShell@2
            displayName: 'Verify KhulaFxTradeMonitor DLL'
            inputs:
              targetType: 'inline'
              script: |
                $sourceDir = "$(Build.SourcesDirectory)"
                $expectedDllPath = "$sourceDir\KhulaFxTradeMonitor\KhulaFxTradeMonitor\bin\Release\net8.0\KhulaFxTradeMonitor.dll"
                
                if (Test-Path $expectedDllPath) {
                  Write-Host "✅ DLL found" -ForegroundColor Green
                } else {
                  Write-Error "❌ DLL not found"
                  exit 1
                }

          - task: DotNetCoreCLI@2
            displayName: 'Restore KhulaFxAdmin'
            inputs:
              command: 'restore'
              projects: '$(Build.SourcesDirectory)/KhulaFxAdmin/KhulaFxAdmin.csproj'

          - task: DotNetCoreCLI@2
            displayName: 'Build KhulaFxAdmin'
            inputs:
              command: 'build'
              projects: '$(Build.SourcesDirectory)/KhulaFxAdmin/KhulaFxAdmin.csproj'
              arguments: '--configuration Release --no-restore'

          - task: PowerShell@2
            displayName: 'Check Build Output'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "Checking for DLL..." -ForegroundColor Cyan
                $dllPath = "$(Build.SourcesDirectory)/KhulaFxAdmin/bin/Release/net8.0/KhulaFxAdmin.dll"
                
                if (Test-Path $dllPath) {
                  Write-Host "✅ Found: $dllPath" -ForegroundColor Green
                  $size = (Get-Item $dllPath).Length
                  Write-Host "Size: $size bytes" -ForegroundColor Cyan
                } else {
                  Write-Error "❌ DLL NOT FOUND: $dllPath"
                  Write-Host "Searching for DLL files..." -ForegroundColor Yellow
                  Get-ChildItem -Path "$(Build.SourcesDirectory)/KhulaFxAdmin" -Recurse -Include "*.dll" | Select-Object FullName
                  exit 1
                }

          - task: PowerShell@2
            displayName: 'Prepare Artifacts'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "Preparing artifacts..." -ForegroundColor Cyan
                
                $sourceDir = "$(Build.SourcesDirectory)/KhulaFxAdmin/bin/Release/net8.0"
                $stagingDir = "$(Build.ArtifactStagingDirectory)"
                
                # Create staging directory
                if (-not (Test-Path $stagingDir)) {
                  New-Item -ItemType Directory -Path $stagingDir -Force | Out-Null
                }
                
                # Copy all files
                Write-Host "Copying files from: $sourceDir" -ForegroundColor White
                Get-ChildItem -Path $sourceDir | ForEach-Object {
                  Write-Host "Copying: $($_.Name)" -ForegroundColor Cyan
                  Copy-Item -Path $_.FullName -Destination $stagingDir -Recurse -Force
                }
                
                # Create web.config
                $webConfig = @"
                <?xml version="1.0" encoding="utf-8"?>
                <configuration>
                  <location path="." inheritInChildApplications="false">
                    <system.webServer>
                      <handlers>
                        <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" />
                      </handlers>
                      <aspNetCore processPath="dotnet" 
                                  arguments=".\KhulaFxAdmin.dll" 
                                  stdoutLogEnabled="true" 
                                  stdoutLogFile=".\logs\stdout" 
                                  hostingModel="inprocess">
                        <environmentVariables>
                          <environmentVariable name="ASPNETCORE_ENVIRONMENT" value="Production" />
                          <environmentVariable name="ASPNETCORE_URLS" value="http://+:80" />
                        </environmentVariables>
                      </aspNetCore>
                    </system.webServer>
                  </location>
                </configuration>
                "@
                
                $webConfigPath = Join-Path $stagingDir "web.config"
                $webConfig | Out-File -FilePath $webConfigPath -Encoding utf8 -Force
                Write-Host "✅ web.config created" -ForegroundColor Green
                
                # Verify
                Write-Host "`nArtifact contents:" -ForegroundColor Cyan
                Get-ChildItem -Path $stagingDir -Force | ForEach-Object {
                  Write-Host "  $($_.Name)" -ForegroundColor Green
                }

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Artifacts'
            inputs:
              pathToPublish: '$(Build.ArtifactStagingDirectory)'
              artifactName: 'backend-api'

  - stage: Deploy
    displayName: 'Deploy to VPS'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: DeployAPI
        displayName: 'Deploy to IIS'
        steps:
          - download: current
            artifact: backend-api

          - task: PowerShell@2
            displayName: 'Stop IIS App Pool'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "Stopping IIS App Pool..." -ForegroundColor Yellow
                
                $vpsIP = "$(vpsServer)"
                $appPoolName = "KhulaFxAppPool"
                
                # Use PSSession to stop app pool remotely
                $securePassword = ConvertTo-SecureString "$(DEPLOY_PASSWORD)" -AsPlainText -Force
                $credential = New-Object PSCredential("$(deployUser)", $securePassword)
                
                try {
                  $session = New-PSSession -ComputerName $vpsIP -Credential $credential -ErrorAction Stop
                  
                  Invoke-Command -Session $session -ScriptBlock {
                    param($poolName)
                    $pool = Get-WebAppPool -Name $poolName -ErrorAction SilentlyContinue
                    if ($pool) {
                      if ($pool.State -eq "Started") {
                        Stop-WebAppPool -Name $poolName
                        Write-Host "✅ Stopped: $poolName" -ForegroundColor Green
                        Start-Sleep -Seconds 3
                      } else {
                        Write-Host "App pool already stopped" -ForegroundColor Yellow
                      }
                    } else {
                      Write-Host "App pool not found, continuing anyway" -ForegroundColor Yellow
                    }
                  } -ArgumentList $appPoolName
                  
                  Remove-PSSession -Session $session
                } catch {
                  Write-Host "⚠️ Could not stop app pool: $_" -ForegroundColor Yellow
                  Write-Host "Continuing with deployment anyway..." -ForegroundColor Yellow
                }
                
                Start-Sleep -Seconds 2

          - task: PowerShell@2
            displayName: 'Deploy Files'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "Deploying to VPS..." -ForegroundColor Cyan
                
                $sourcePath = "$(Pipeline.Workspace)/backend-api"
                $vpsIP = "$(vpsServer)"
                $destPath = "\\$vpsIP\c$\inetpub\wwwroot\khulafx.com\api"
                
                Write-Host "Source: $sourcePath" -ForegroundColor White
                Write-Host "Destination: $destPath" -ForegroundColor White
                
                # Verify source
                $sourceFiles = Get-ChildItem -Path $sourcePath -Force
                Write-Host "Source files: $($sourceFiles.Count)" -ForegroundColor Cyan
                $sourceFiles | ForEach-Object { Write-Host "  $_" }
                
                # Create destination if needed
                if (-not (Test-Path $destPath)) {
                  New-Item -ItemType Directory -Path $destPath -Force | Out-Null
                }
                
                # Remove old files (except web.config and logs)
                Write-Host "`nCleaning old files..." -ForegroundColor Yellow
                Get-ChildItem -Path $destPath -Force -ErrorAction SilentlyContinue | Where-Object { $_.Name -notmatch '^(web\.config|logs)$' } | ForEach-Object {
                  try {
                    if ($_.PSIsContainer) {
                      Remove-Item -Path $_.FullName -Recurse -Force -ErrorAction Stop
                    } else {
                      Remove-Item -Path $_.FullName -Force -ErrorAction Stop
                    }
                  } catch {
                    Write-Host "⚠️ Could not remove $($_.Name)" -ForegroundColor Yellow
                  }
                }
                
                Write-Host "Copying new files..." -ForegroundColor Cyan
                $copiedCount = 0
                
                # Copy files (skip web.config - it's locked by IIS)
                $sourceFiles | Where-Object { $_.Name -ne "web.config" } | ForEach-Object {
                  try {
                    if ($_.PSIsContainer) {
                      Copy-Item -Path $_.FullName -Destination $destPath -Recurse -Force -ErrorAction Stop
                    } else {
                      Copy-Item -Path $_.FullName -Destination $destPath -Force -ErrorAction Stop
                    }
                    Write-Host "✅ Copied: $($_.Name)" -ForegroundColor Green
                    $copiedCount++
                  } catch {
                    Write-Host "❌ Failed to copy $($_.Name): $_" -ForegroundColor Red
                  }
                }
                
                # Verify
                Start-Sleep -Seconds 2
                $dllExists = Test-Path "$destPath\KhulaFxAdmin.dll"
                Write-Host "`nVerification:" -ForegroundColor Yellow
                Write-Host "  Files copied: $copiedCount" -ForegroundColor Cyan
                Write-Host "  DLL: $(if($dllExists){'✅ FOUND'}else{'❌ MISSING'})" -ForegroundColor $(if($dllExists){'Green'}else{'Red'})
                
                if (-not $dllExists) {
                  Write-Error "Deployment failed: DLL not found at destination"
                  exit 1
                }
                
                Write-Host "`n✅ Deployment successful!" -ForegroundColor Green

          - task: PowerShell@2
            displayName: 'Start IIS App Pool'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "Starting IIS App Pool..." -ForegroundColor Yellow
                
                $vpsIP = "$(vpsServer)"
                $appPoolName = "KhulaFxAppPool"
                
                $securePassword = ConvertTo-SecureString "$(DEPLOY_PASSWORD)" -AsPlainText -Force
                $credential = New-Object PSCredential("$(deployUser)", $securePassword)
                
                try {
                  $session = New-PSSession -ComputerName $vpsIP -Credential $credential -ErrorAction Stop
                  
                  Invoke-Command -Session $session -ScriptBlock {
                    param($poolName)
                    $pool = Get-WebAppPool -Name $poolName -ErrorAction SilentlyContinue
                    if ($pool) {
                      Start-WebAppPool -Name $poolName
                      Write-Host "✅ Started: $poolName" -ForegroundColor Green
                      Start-Sleep -Seconds 3
                    }
                  } -ArgumentList $appPoolName
                  
                  Remove-PSSession -Session $session
                } catch {
                  Write-Host "⚠️ Could not start app pool: $_" -ForegroundColor Yellow
                }

          - task: PowerShell@2
            displayName: 'Verify Deployment'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "Testing API endpoint..." -ForegroundColor Cyan
                Start-Sleep -Seconds 5
                
                try {
                  $response = Invoke-WebRequest -Uri "http://108.181.161.170/api" -UseBasicParsing -TimeoutSec 10
                  Write-Host "✅ API responding: $($response.StatusCode)" -ForegroundColor Green
                } catch {
                  if ($_.Exception.Response.StatusCode -eq 404) {
                    Write-Host "✅ API running (404 is expected on /api)" -ForegroundColor Green
                  } else {
                    Write-Host "⚠️ Response: $($_.Exception.Message)" -ForegroundColor Yellow
                  }
                }