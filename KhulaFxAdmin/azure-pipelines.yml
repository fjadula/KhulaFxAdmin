# Azure Pipeline for KhulaFxAdmin (Backend API)
# Repository: KhulaFxAdmin
# Deploys to: https://khulafx.com/api
# Physical Path: C:\inetpub\wwwroot\khulafx.com\api
# App Pool: KhulaFxAppPool

trigger:
  branches:
    include:
      - main
      - master

pool:
  name: 'Default'

variables:
  - group: 'Deployment-Secrets'

stages:
  - stage: NotifyStart
    displayName: 'Notify Build Started'
    jobs:
      - job: Telegram
        displayName: 'Send Telegram Notification'
        steps:
          - task: PowerShell@2
            displayName: 'Send Start Notification'
            inputs:
              targetType: 'inline'
              script: |
                $message = "üöÄ *KhulaFxAdmin API Build Started*`n`n"
                $message += "üì¶ *Project:* KhulaFxAdmin (Backend API)`n"
                $message += "üî¢ *Build:* $(Build.BuildNumber)`n"
                $message += "üë§ *By:* $(Build.RequestedFor)`n"
                $message += "üåø *Branch:* $(Build.SourceBranchName)`n"
                $message += "üí¨ *Commit:* $(Build.SourceVersionMessage)`n"
                $message += "üîó [View](https://dev.azure.com/KhulaFx/KhulaFxTrade/_build/results?buildId=$(Build.BuildId))"
                
                $body = @{ chat_id = "$(TELEGRAM_CHAT_ID)"; text = $message; parse_mode = "Markdown" } | ConvertTo-Json
                
                try {
                  Invoke-RestMethod -Uri "https://api.telegram.org/bot$(TELEGRAM_BOT_TOKEN)/sendMessage" `
                    -Method Post -ContentType "application/json" -Body $body
                } catch { Write-Warning "Telegram failed: $_" }

  - stage: Build
    displayName: 'Build Backend API'
    dependsOn: NotifyStart
    jobs:
      - job: BuildAPI
        displayName: 'Build .NET 8 API'
        steps:
          - checkout: self
            fetchDepth: 1

          - task: UseDotNet@2
            displayName: 'Install .NET 8 SDK'
            inputs:
              version: '8.x'

          - task: DotNetCoreCLI@2
            displayName: 'Restore Packages'
            inputs:
              command: 'restore'
              projects: '**/*.csproj'

          - task: DotNetCoreCLI@2
            displayName: 'Build Project'
            inputs:
              command: 'build'
              projects: '**/*.csproj'
              arguments: '--configuration Release --no-restore'

          - task: DotNetCoreCLI@2
            displayName: 'Publish for IIS'
            inputs:
              command: 'publish'
              publishWebProjects: true
              projects: '**/*.csproj'
              arguments: '--configuration Release --output $(Build.ArtifactStagingDirectory) --no-build'
              zipAfterPublish: false

          - task: PowerShell@2
            displayName: 'Create web.config for IIS'
            inputs:
              targetType: 'inline'
              script: |
                # Find the published directory (usually first subdirectory)
                $publishDir = Get-ChildItem -Path "$(Build.ArtifactStagingDirectory)" -Directory | Select-Object -First 1
                
                if (-not $publishDir) {
                  $publishDir = "$(Build.ArtifactStagingDirectory)"
                }
                
                $webConfig = @"
                <?xml version="1.0" encoding="utf-8"?>
                <configuration>
                  <location path="." inheritInChildApplications="false">
                    <system.webServer>
                      <handlers>
                        <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" />
                      </handlers>
                      <aspNetCore processPath="dotnet" 
                                  arguments=".\KhulaFxAdmin.dll" 
                                  stdoutLogEnabled="true" 
                                  stdoutLogFile=".\logs\stdout" 
                                  hostingModel="inprocess">
                        <environmentVariables>
                          <environmentVariable name="ASPNETCORE_ENVIRONMENT" value="Production" />
                          <environmentVariable name="ASPNETCORE_URLS" value="http://+:80" />
                        </environmentVariables>
                      </aspNetCore>
                      <rewrite>
                        <rules>
                          <rule name="HTTP to HTTPS" stopProcessing="true">
                            <match url="(.*)" />
                            <conditions>
                              <add input="{HTTPS}" pattern="off" ignoreCase="true" />
                            </conditions>
                            <action type="Redirect" url="https://{HTTP_HOST}{REQUEST_URI}" redirectType="Permanent" />
                          </rule>
                        </rules>
                      </rewrite>
                    </system.webServer>
                  </location>
                </configuration>
                "@
                
                $webConfigPath = Join-Path $publishDir.FullName "web.config"
                $webConfig | Out-File -FilePath $webConfigPath -Encoding utf8 -Force
                
                Write-Host "‚úÖ web.config created at: $webConfigPath" -ForegroundColor Green
                Write-Host "üìÅ Publish directory: $($publishDir.FullName)" -ForegroundColor Cyan

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Artifacts'
            inputs:
              pathToPublish: '$(Build.ArtifactStagingDirectory)'
              artifactName: 'backend-api'

  - stage: Deploy
    displayName: 'Deploy to VPS'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: DeployAPI
        displayName: 'Deploy to IIS'
        steps:
          - download: current
            artifact: backend-api

          - task: PowerShell@2
            displayName: 'Deploy via Network Share'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "========================================" -ForegroundColor Cyan
                Write-Host "Deploying KhulaFxAdmin API to VPS" -ForegroundColor Cyan
                Write-Host "========================================" -ForegroundColor Cyan
                Write-Host ""
                
                # Find the published app folder (usually first subdirectory)
                $sourcePath = Get-ChildItem -Path "$(Pipeline.Workspace)/backend-api" -Directory | Select-Object -First 1
                
                if (-not $sourcePath) {
                  $sourcePath = "$(Pipeline.Workspace)/backend-api"
                  Write-Host "Using root deployment path" -ForegroundColor Yellow
                } else {
                  Write-Host "Found published app: $($sourcePath.Name)" -ForegroundColor Green
                }
                
                $destinationPath = "\\$(vpsServer)\c$\inetpub\wwwroot\khulafx.com\api"
                
                Write-Host "Source: $($sourcePath.FullName)" -ForegroundColor White
                Write-Host "Destination: $destinationPath" -ForegroundColor White
                Write-Host ""
                
                try {
                  # Stop App Pool
                  Write-Host "Stopping application pool..." -ForegroundColor Yellow
                  $stopCmd = "Stop-WebAppPool -Name 'KhulaFxAppPool' -ErrorAction SilentlyContinue"
                  Invoke-Command -ComputerName $(vpsServer) -ScriptBlock {
                    param($cmd)
                    Import-Module WebAdministration
                    Invoke-Expression $cmd
                  } -ArgumentList $stopCmd -ErrorAction SilentlyContinue
                  
                  Start-Sleep -Seconds 5
                  Write-Host "‚úÖ App pool stopped" -ForegroundColor Green
                  
                  # Ensure directory exists
                  if (-not (Test-Path $destinationPath)) {
                    New-Item -ItemType Directory -Path $destinationPath -Force | Out-Null
                    Write-Host "‚úÖ Created directory" -ForegroundColor Green
                  }
                  
                  # Clean destination
                  Write-Host "Cleaning destination folder..." -ForegroundColor Yellow
                  Get-ChildItem -Path $destinationPath -Recurse -File | Remove-Item -Force -ErrorAction SilentlyContinue
                  Get-ChildItem -Path $destinationPath -Recurse -Directory | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
                  Write-Host "‚úÖ Destination cleaned" -ForegroundColor Green
                  
                  # Copy files
                  Write-Host "Copying application files..." -ForegroundColor Yellow
                  Copy-Item -Path "$($sourcePath.FullName)\*" -Destination $destinationPath -Recurse -Force -ErrorAction Stop
                  Write-Host "‚úÖ Files copied successfully" -ForegroundColor Green
                  
                  # Verify deployment
                  $files = Get-ChildItem -Path $destinationPath -Recurse -File
                  Write-Host ""
                  Write-Host "========================================" -ForegroundColor Green
                  Write-Host "‚úÖ Deployment Complete!" -ForegroundColor Green
                  Write-Host "========================================" -ForegroundColor Green
                  Write-Host "Files deployed: $($files.Count)" -ForegroundColor Cyan
                  Write-Host "Location: $destinationPath" -ForegroundColor Cyan
                  Write-Host ""
                  
                  # Verify key files
                  $dllExists = Test-Path "$destinationPath\KhulaFxAdmin.dll"
                  $webConfigExists = Test-Path "$destinationPath\web.config"
                  
                  Write-Host "Key files check:" -ForegroundColor Yellow
                  Write-Host "  ‚úÖ KhulaFxAdmin.dll: $(if($dllExists){'Found'}else{'MISSING'})" -ForegroundColor $(if($dllExists){'Green'}else{'Red'})
                  Write-Host "  ‚úÖ web.config: $(if($webConfigExists){'Found'}else{'MISSING'})" -ForegroundColor $(if($webConfigExists){'Green'}else{'Red'})
                  
                  # Start App Pool
                  Write-Host ""
                  Write-Host "Starting application pool..." -ForegroundColor Yellow
                  $startCmd = "Start-WebAppPool -Name 'KhulaFxAppPool' -ErrorAction SilentlyContinue"
                  Invoke-Command -ComputerName $(vpsServer) -ScriptBlock {
                    param($cmd)
                    Import-Module WebAdministration
                    Invoke-Expression $cmd
                  } -ArgumentList $startCmd -ErrorAction SilentlyContinue
                  
                  Start-Sleep -Seconds 5
                  Write-Host "‚úÖ App pool started" -ForegroundColor Green
                  
                  if (-not $dllExists -or -not $webConfigExists) {
                    Write-Error "Critical files missing!"
                    exit 1
                  }
                }
                catch {
                  Write-Host ""
                  Write-Host "========================================" -ForegroundColor Red
                  Write-Host "‚ùå Deployment Failed!" -ForegroundColor Red
                  Write-Host "========================================" -ForegroundColor Red
                  Write-Error $_.Exception.Message
                  exit 1
                }

          - task: PowerShell@2
            displayName: 'Verify API Deployment'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "Waiting for API to start..." -ForegroundColor Yellow
                Start-Sleep -Seconds 10
                
                Write-Host "Testing API endpoints..." -ForegroundColor Yellow
                Write-Host ""
                
                $urls = @(
                  "https://khulafx.com/api",
                  "http://khulafx.com/api",
                  "http://$(vpsServer)/api"
                )
                
                $success = $false
                foreach ($url in $urls) {
                  try {
                    Write-Host "Testing: $url" -ForegroundColor Gray
                    $response = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 30 -ErrorAction Stop
                    Write-Host "  ‚úÖ Status: $($response.StatusCode)" -ForegroundColor Green
                    $success = $true
                  }
                  catch {
                    # 404 on /api is expected if no default route exists
                    if ($_.Exception.Response.StatusCode -eq 404) {
                      Write-Host "  ‚úÖ Status: 404 (API is running, no default route)" -ForegroundColor Green
                      $success = $true
                    } else {
                      Write-Host "  ‚ö†Ô∏è $($_.Exception.Message)" -ForegroundColor Yellow
                    }
                  }
                }
                
                Write-Host ""
                if ($success) {
                  Write-Host "========================================" -ForegroundColor Green
                  Write-Host "‚úÖ API is Live and Accessible!" -ForegroundColor Green
                  Write-Host "========================================" -ForegroundColor Green
                  Write-Host "API URL: https://khulafx.com/api" -ForegroundColor Cyan
                  Write-Host "Physical Path: C:\inetpub\wwwroot\khulafx.com\api" -ForegroundColor Cyan
                } else {
                  Write-Warning "API not responding yet"
                  Write-Host "Files are deployed to:" -ForegroundColor Cyan
                  Write-Host "  C:\inetpub\wwwroot\khulafx.com\api\" -ForegroundColor White
                  Write-Host ""
                  Write-Host "If API still doesn't work, check on VPS:" -ForegroundColor Yellow
                  Write-Host "  1. App Pool 'KhulaFxAppPool' is running" -ForegroundColor White
                  Write-Host "  2. IIS Logs: C:\inetpub\logs\LogFiles\W3SVC1\" -ForegroundColor White
                  Write-Host "  3. .NET Runtime logs in: C:\inetpub\wwwroot\khulafx.com\api\logs\stdout_*" -ForegroundColor White
                }

  - stage: NotifyComplete
    displayName: 'Notify Completion'
    dependsOn: Deploy
    condition: always()
    jobs:
      - job: SendResult
        displayName: 'Send Telegram Result'
        steps:
          - task: PowerShell@2
            displayName: 'Send Notification'
            inputs:
              targetType: 'inline'
              script: |
                $success = "$(Agent.JobStatus)" -eq "Succeeded"
                $icon = if ($success) { "‚úÖ" } else { "‚ùå" }
                $status = if ($success) { "SUCCESS" } else { "FAILED" }
                
                $message = "$icon *KhulaFxAdmin API Deploy $status!*`n`n"
                $message += "üì¶ *Project:* KhulaFxAdmin (Backend API)`n"
                $message += "üî¢ *Build:* $(Build.BuildNumber)`n"
                $message += "üë§ *By:* $(Build.RequestedFor)`n"
                $message += "üåø *Branch:* $(Build.SourceBranchName)`n"
                $message += "üí¨ *Commit:* $(Build.SourceVersionMessage)`n"
                
                if ($success) {
                  $message += "üåê *URL:* https://khulafx.com/api`n"
                  $message += "üìÅ *Path:* C:\inetpub\wwwroot\khulafx.com\api`n"
                  $message += "üîÑ *Pool:* KhulaFxAppPool`n"
                }
                
                $duration = [math]::Round((New-TimeSpan -Start '$(System.PipelineStartTime)' -End (Get-Date)).TotalMinutes, 2)
                $message += "‚è±Ô∏è *Duration:* $duration minutes`n"
                $message += "üîó [View Logs](https://dev.azure.com/KhulaFx/KhulaFxTrade/_build/results?buildId=$(Build.BuildId))"
                
                $body = @{ chat_id = "$(TELEGRAM_CHAT_ID)"; text = $message; parse_mode = "Markdown" } | ConvertTo-Json
                
                try {
                  Invoke-RestMethod -Uri "https://api.telegram.org/bot$(TELEGRAM_BOT_TOKEN)/sendMessage" `
                    -Method Post -ContentType "application/json" -Body $body
                } catch { Write-Warning "Telegram failed: $_" }