# ========================================================
# Azure DevOps Pipeline B for KhulaFxAdmin
# Builds and references KhulaFxTradeMonitor.dll from Pipeline A
# ========================================================

trigger:
  branches:
    include:
      - master
      - main

variables:
  - group: Deployment-Secrets
  - name: buildConfiguration
    value: 'Release'
  - name: dotnetVersion
    value: '8.x'
  - name: pipelineAProject
    value: 'KhulaFxTrade'
  - name: pipelineAName
    value: 'fjadula.KhulaFxTradeMonitor'

stages:
# ================================
# RESTORE AND DOWNLOAD DLL
# ================================
- stage: Restore
  displayName: 'Restore & Download DLL'
  jobs:
  - job: RestoreJob
    displayName: 'Restore NuGet & Download DLL'
    pool:
      name: 'Default'
    steps:
    - checkout: self
      fetchDepth: 1

    - task: UseDotNet@2
      displayName: 'Install .NET SDK 8.x'
      inputs:
        packageType: sdk
        version: $(dotnetVersion)

    # -----------------------------
    # Download DLL artifact from Pipeline A
    # -----------------------------
    - task: DownloadPipelineArtifact@2
      displayName: 'Download KhulaFxTradeMonitor.dll from Pipeline A'
      inputs:
        source: 'specific'
        project: $(pipelineAProject)
        pipeline: $(pipelineAName)
        runVersion: 'latest'
        artifact: 'KhulaFxTradeMonitorDLL'
        path: '$(Build.SourcesDirectory)\libs'

    # -----------------------------
    # List downloaded files
    # -----------------------------
    - task: PowerShell@2
      displayName: 'List downloaded DLL files'
      inputs:
        targetType: inline
        script: |
          Write-Host "DLL files in libs folder:"
          Get-ChildItem "$(Build.SourcesDirectory)\libs" -Recurse | ForEach-Object { Write-Host $_.FullName }

# ================================
# INJECT DLL REFERENCE
# ================================
- stage: InjectReference
  displayName: 'Inject DLL Reference'
  dependsOn: Restore
  jobs:
  - job: InjectDLL
    displayName: 'Add KhulaFxTradeMonitor.dll reference'
    pool:
      name: 'Default'
    steps:
    - task: PowerShell@2
      displayName: 'Inject DLL Reference into KhulaFxAdmin.csproj'
      inputs:
        targetType: inline
        script: |
          $projectFile = "$(Build.SourcesDirectory)\KhulaFxAdmin\KhulaFxAdmin.csproj"
          $dllFolder = "$(Build.SourcesDirectory)\libs"
          $dllName = "KhulaFxTradeMonitor.dll"

          Write-Host "Injecting DLL reference into $projectFile"

          [xml]$xml = Get-Content $projectFile

          $ns = @{msb='http://schemas.microsoft.com/developer/msbuild/2003'}
          $projectNode = $xml.Project

          # Check if ItemGroup exists for references
          $itemGroup = $projectNode.ItemGroup | Where-Object { $_.Reference }
          if (-not $itemGroup) {
              $itemGroup = $xml.CreateElement("ItemGroup", $projectNode.NamespaceURI)
              $projectNode.AppendChild($itemGroup) | Out-Null
          }

          # Add reference if it doesn't exist
          $exists = $itemGroup.Reference | Where-Object { $_.Include -eq "KhulaFxTradeMonitor" }
          if (-not $exists) {
              $ref = $xml.CreateElement("Reference", $projectNode.NamespaceURI)
              $ref.SetAttribute("Include", "KhulaFxTradeMonitor")
              $hintPath = $xml.CreateElement("HintPath", $projectNode.NamespaceURI)
              $hintPath.InnerText = "$dllFolder\$dllName"
              $ref.AppendChild($hintPath) | Out-Null
              $itemGroup.AppendChild($ref) | Out-Null
              Write-Host "âœ… DLL reference injected successfully."
          } else {
              Write-Host "DLL reference already exists, skipping injection."
          }

          $xml.Save($projectFile)

# ================================
# BUILD
# ================================
- stage: Build
  displayName: 'Build KhulaFxAdmin'
  dependsOn: InjectReference
  jobs:
  - job: BuildJob
    displayName: 'Build Project'
    pool:
      name: 'Default'
    steps:
    - task: PowerShell@2
      displayName: 'Restore NuGet Packages'
      inputs:
        targetType: inline
        script: |
          dotnet restore "$(Build.SourcesDirectory)\KhulaFxAdmin\KhulaFxAdmin.csproj"

    - task: PowerShell@2
      displayName: 'Build Project'
      inputs:
        targetType: inline
        script: |
          dotnet build "$(Build.SourcesDirectory)\KhulaFxAdmin\KhulaFxAdmin.csproj" `
            -c $(buildConfiguration) `
            -o "$(Build.ArtifactStagingDirectory)\KhulaFxAdmin"

    - task: PowerShell@2
      displayName: 'List Build Output'
      inputs:
        targetType: inline
        script: |
          Get-ChildItem "$(Build.ArtifactStagingDirectory)\KhulaFxAdmin" -Recurse | ForEach-Object { Write-Host $_.FullName }

# ================================
# PUBLISH ARTIFACTS
# ================================
- stage: Publish
  displayName: 'Publish Artifacts'
  dependsOn: Build
  jobs:
  - job: PublishJob
    displayName: 'Publish Build Artifacts'
    pool:
      name: 'Default'
    steps:
    - task: PublishBuildArtifacts@1
      displayName: 'Publish KhulaFxAdmin DLLs'
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)\KhulaFxAdmin'
        artifactName: 'KhulaFxAdmin'
        publishLocation: 'Container'
