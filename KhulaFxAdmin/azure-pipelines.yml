trigger:
  - master
  - main

pool:
  name: Default

variables:
  - group: Deployment-Secrets

stages:
  - stage: Build
    jobs:
      - job: BuildJob
        steps:
          - checkout: self

          - task: UseDotNet@2
            displayName: Install .NET 8
            inputs:
              version: 8.x

          # ‚úÖ Step 1: Download the KhulaFxTradeMonitor.dll from another pipeline (Pipeline A)
          - task: DownloadPipelineArtifact@2
            displayName: Download KhulaFxTradeMonitor DLL (from Pipeline A)
            inputs:
              source: specific
              project: "$(System.TeamProject)"
              pipeline: "PipelineA"       # üëà replace with the actual pipeline name or ID
              buildVersionToDownload: latest
              artifact: "library"
              targetPath: "$(Pipeline.Workspace)/libs"

          # ‚úÖ Step 2: Inject DLL and update .csproj dynamically
          - task: PowerShell@2
            displayName: Inject DLL and Update csproj
            inputs:
              targetType: inline
              script: |
                $dllSource = "$(Pipeline.Workspace)/libs/KhulaFxTradeMonitor.dll"
                $projectFile = "$(Pipeline.Workspace)/KhulaFxAdmin/KhulaFxAdmin.csproj"
                $dllTargetDir = "$(Pipeline.Workspace)/KhulaFxAdmin"

                Write-Host "Injecting KhulaFxTradeMonitor.dll into KhulaFxAdmin..."
                if (-Not (Test-Path $dllSource)) {
                  Write-Error "‚ùå DLL not found at $dllSource"
                  exit 1
                }

                Copy-Item -Path $dllSource -Destination $dllTargetDir -Force
                Write-Host "‚úÖ DLL copied successfully"

                [xml]$csproj = Get-Content $projectFile
                $ns = @{msb='http://schemas.microsoft.com/developer/msbuild/2003'}
                $existingRef = $csproj.Project.ItemGroup.Reference | Where-Object { $_.Include -eq "KhulaFxTradeMonitor" }

                if (-not $existingRef) {
                  Write-Host "Adding reference to KhulaFxTradeMonitor..."
                  $itemGroup = $csproj.CreateElement("ItemGroup", $csproj.Project.NamespaceURI)
                  $reference = $csproj.CreateElement("Reference", $csproj.Project.NamespaceURI)
                  $reference.SetAttribute("Include", "KhulaFxTradeMonitor")

                  $hintPath = $csproj.CreateElement("HintPath", $csproj.Project.NamespaceURI)
                  $hintPath.InnerText = "KhulaFxTradeMonitor.dll"
                  $reference.AppendChild($hintPath) | Out-Null

                  $privateNode = $csproj.CreateElement("Private", $csproj.Project.NamespaceURI)
                  $privateNode.InnerText = "true"
                  $reference.AppendChild($privateNode) | Out-Null

                  $itemGroup.AppendChild($reference) | Out-Null
                  $csproj.Project.AppendChild($itemGroup) | Out-Null
                  $csproj.Save($projectFile)
                  Write-Host "‚úÖ csproj updated successfully"
                } else {
                  Write-Host "‚ÑπÔ∏è Reference already exists, skipping update."
                }

          # ‚úÖ Step 3: Verify injection before building
          - task: PowerShell@2
            displayName: Verify DLL Injection
            inputs:
              targetType: inline
              script: |
                $dllPath = "$(Pipeline.Workspace)/KhulaFxAdmin/KhulaFxTradeMonitor.dll"
                $csprojFile = "$(Pipeline.Workspace)/KhulaFxAdmin/KhulaFxAdmin.csproj"

                Write-Host "üîç Verifying DLL injection..."
                if (Test-Path $dllPath) {
                  Write-Host "‚úÖ Found KhulaFxTradeMonitor.dll"
                } else {
                  Write-Error "‚ùå Missing DLL in project folder!"
                  exit 1
                }

                $content = Get-Content $csprojFile -Raw
                if ($content -match "KhulaFxTradeMonitor.dll") {
                  Write-Host "‚úÖ Reference confirmed in csproj"
                } else {
                  Write-Error "‚ùå Reference missing in csproj!"
                  exit 1
                }

          # ‚úÖ Step 4: Build the project
          - task: DotNetCoreCLI@2
            displayName: Build Release
            inputs:
              command: build
              projects: KhulaFxAdmin/KhulaFxAdmin.csproj
              arguments: --configuration Release

          # ‚úÖ Step 5: Publish Release
          - task: DotNetCoreCLI@2
            displayName: Publish Release
            inputs:
              command: publish
              projects: KhulaFxAdmin/KhulaFxAdmin.csproj
              arguments: --configuration Release --output $(Build.ArtifactStagingDirectory) -p:PublishSingleFile=false

          # ‚úÖ Step 6: Publish Build Artifacts
          - task: PublishBuildArtifacts@1
            displayName: Publish Artifacts
            inputs:
              pathToPublish: $(Build.ArtifactStagingDirectory)
              artifactName: backend

  # ‚úÖ Stage 2: Deployment to VPS
  - stage: Deploy
    displayName: Deploy to VPS
    dependsOn: Build
    jobs:
      - job: DeployJob
        displayName: Deploy Backend
        steps:
          - download: current
            artifact: backend

          - task: PowerShell@2
            displayName: Deploy to IIS
            inputs:
              targetType: inline
              script: |
                $src = "$(Pipeline.Workspace)/backend"
                $vps = "$(vpsServer)"
                $dst = "\\$vps\c$\inetpub\wwwroot\khulafx.com\api"
                $username = "$(deployUser)"
                $password = "$(DEPLOY_PASSWORD)"

                Write-Host "========================================"
                Write-Host "üöÄ Deploying Backend to VPS..."
                Write-Host "========================================"

                net use * /delete /y 2>&1 | Out-Null
                Start-Sleep -Seconds 2

                $secPassword = ConvertTo-SecureString $password -AsPlainText -Force
                $cred = New-Object System.Management.Automation.PSCredential("$vps\$username", $secPassword)
                try {
                  $session = New-PSSession -ComputerName $vps -Credential $cred -ErrorAction Stop
                  Invoke-Command -Session $session -ScriptBlock { net stop W3SVC; Start-Sleep -Seconds 3 }
                  Remove-PSSession $session
                } catch {
                  Write-Host "‚ö†Ô∏è Could not stop IIS, continuing..."
                }

                net use "\\$vps\c$" /user:"$vps\$username" "$password" /persistent:no
                if ($LASTEXITCODE -ne 0) {
                  Write-Error "‚ùå Authentication failed"
                  exit 1
                }

                Write-Host "‚úÖ Authenticated, copying new files..."
                Get-ChildItem -Path $dst -Recurse -Force -ErrorAction SilentlyContinue | 
                  Where-Object { $_.Name -ne "web.config" } |
                  Remove-Item -Recurse -Force -ErrorAction SilentlyContinue

                Copy-Item -Path "$src\*" -Destination $dst -Recurse -Force
                Write-Host "‚úÖ Files copied"

                $session = New-PSSession -ComputerName $vps -Credential $cred -ErrorAction Stop
                Invoke-Command -Session $session -ScriptBlock { net start W3SVC; Start-Sleep -Seconds 3 }
                Remove-PSSession $session

                Write-Host "‚úÖ Deployment Complete!"
                Write-Host "üåê https://khulafx.com/api"
