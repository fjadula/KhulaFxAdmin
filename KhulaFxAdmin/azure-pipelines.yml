# Azure Pipeline for KhulaFxAdmin (Backend API)
# Repository: KhulaFxAdmin
# Deploys to: http://108.181.161.170/api

trigger:
  branches:
    include:
      - main
      - master

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'
  dotnetVersion: '8.0.x'
  vpsServer: '108.181.161.170'
  deployUser: 'deployer'
  # Secrets stored in Azure DevOps Library:
  # - DEPLOY_PASSWORD
  # - TELEGRAM_BOT_TOKEN  
  # - TELEGRAM_CHAT_ID

stages:
  - stage: NotifyStart
    displayName: 'Notify Build Started'
    jobs:
      - job: Telegram
        displayName: 'Send Telegram Notification'
        steps:
          - task: PowerShell@2
            displayName: 'Send Start Notification'
            inputs:
              targetType: 'inline'
              script: |
                $message = "üöÄ *KhulaFxAdmin API Build Started*`n`n"
                $message += "üì¶ *Project:* KhulaFxAdmin (Backend)`n"
                $message += "üî¢ *Build:* $(Build.BuildNumber)`n"
                $message += "üë§ *By:* $(Build.RequestedFor)`n"
                $message += "üåø *Branch:* $(Build.SourceBranchName)`n"
                $message += "üí¨ *Commit:* $(Build.SourceVersionMessage)`n"
                $message += "üîó [View](https://dev.azure.com/KhulaFx/KhulaFxTrade/_build/results?buildId=$(Build.BuildId))"
                
                $body = @{ chat_id = "$(TELEGRAM_CHAT_ID)"; text = $message; parse_mode = "Markdown" } | ConvertTo-Json
                
                try {
                  Invoke-RestMethod -Uri "https://api.telegram.org/bot$(TELEGRAM_BOT_TOKEN)/sendMessage" `
                    -Method Post -ContentType "application/json" -Body $body
                } catch { Write-Warning "Telegram failed: $_" }

  - stage: Build
    displayName: 'Build Backend API'
    dependsOn: NotifyStart
    jobs:
      - job: BuildAPI
        displayName: 'Build .NET 8 API'
        steps:
          - checkout: self
            fetchDepth: 1

          - task: UseDotNet@2
            displayName: 'Install .NET 8 SDK'
            inputs:
              version: $(dotnetVersion)

          - task: DotNetCoreCLI@2
            displayName: 'Restore Packages'
            inputs:
              command: 'restore'
              projects: '**/*.csproj'

          - task: DotNetCoreCLI@2
            displayName: 'Build Project'
            inputs:
              command: 'build'
              projects: '**/*.csproj'
              arguments: '--configuration $(buildConfiguration) --no-restore'

          - task: DotNetCoreCLI@2
            displayName: 'Publish for IIS'
            inputs:
              command: 'publish'
              publishWebProjects: true
              projects: '**/*.csproj'
              arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory) --no-build'
              zipAfterPublish: false

          - task: PowerShell@2
            displayName: 'Ensure web.config'
            inputs:
              targetType: 'inline'
              script: |
                $webConfig = @"
                <?xml version="1.0" encoding="utf-8"?>
                <configuration>
                  <location path="." inheritInChildApplications="false">
                    <system.webServer>
                      <handlers>
                        <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" />
                      </handlers>
                      <aspNetCore processPath="dotnet" 
                                  arguments=".\KhulaFxAdmin.dll" 
                                  stdoutLogEnabled="true" 
                                  stdoutLogFile=".\logs\stdout" 
                                  hostingModel="inprocess">
                        <environmentVariables>
                          <environmentVariable name="ASPNETCORE_ENVIRONMENT" value="Production" />
                        </environmentVariables>
                      </aspNetCore>
                    </system.webServer>
                  </location>
                </configuration>
                "@
                
                $path = "$(Build.ArtifactStagingDirectory)/web.config"
                if (-not (Test-Path $path)) {
                  $webConfig | Out-File -FilePath $path -Encoding utf8
                  Write-Host "‚úÖ web.config created"
                }

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Artifacts'
            inputs:
              pathToPublish: '$(Build.ArtifactStagingDirectory)'
              artifactName: 'backend-api'

  - stage: Deploy
    displayName: 'Deploy to VPS'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployAPI
        displayName: 'Deploy to IIS'
        environment: 'VPS-Production'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: backend-api

                - task: PowerShell@2
                  displayName: 'Deploy via Web Deploy'
                  inputs:
                    targetType: 'inline'
                    script: |
                      Write-Host "========================================" -ForegroundColor Cyan
                      Write-Host "Deploying KhulaFxAdmin API to VPS" -ForegroundColor Cyan
                      Write-Host "========================================" -ForegroundColor Cyan
                      
                      $msdeploy = "C:\Program Files\IIS\Microsoft Web Deploy V3\msdeploy.exe"
                      
                      if (-not (Test-Path $msdeploy)) {
                        Write-Error "‚ùå Web Deploy not found"
                        exit 1
                      }
                      
                      try {
                        Write-Host "Source: $(Pipeline.Workspace)/backend-api"
                        Write-Host "Target: $(vpsServer)/api"
                        Write-Host ""
                        
                        & $msdeploy `
                          -verb:sync `
                          -source:contentPath="$(Pipeline.Workspace)/backend-api" `
                          -dest:contentPath='Default Web Site/api',ComputerName="https://$(vpsServer):8172/MsDeploy.axd",UserName='$(deployUser)',Password='$(DEPLOY_PASSWORD)',AuthType='Basic' `
                          -allowUntrusted `
                          -verbose
                        
                        if ($LASTEXITCODE -ne 0) {
                          Write-Error "‚ùå Deployment failed with code: $LASTEXITCODE"
                          exit $LASTEXITCODE
                        }
                        
                        Write-Host ""
                        Write-Host "‚úÖ API deployed successfully!" -ForegroundColor Green
                      }
                      catch {
                        Write-Error "‚ùå Deployment failed: $_"
                        exit 1
                      }

                - task: PowerShell@2
                  displayName: 'Verify Deployment'
                  inputs:
                    targetType: 'inline'
                    script: |
                      Write-Host "Testing API endpoint..." -ForegroundColor Yellow
                      Start-Sleep -Seconds 10
                      
                      try {
                        $response = Invoke-WebRequest -Uri "http://$(vpsServer)/api" -UseBasicParsing -TimeoutSec 30
                        Write-Host "‚úÖ API Status: $($response.StatusCode)" -ForegroundColor Green
                      }
                      catch {
                        Write-Warning "‚ö†Ô∏è API test: $($_.Exception.Message)"
                        Write-Host "This may be normal if no default route exists" -ForegroundColor Gray
                      }

  - stage: NotifyComplete
    displayName: 'Notify Completion'
    dependsOn: Deploy
    condition: always()
    jobs:
      - job: SendResult
        displayName: 'Send Telegram Result'
        steps:
          - task: PowerShell@2
            displayName: 'Send Notification'
            inputs:
              targetType: 'inline'
              script: |
                $success = "$(Agent.JobStatus)" -eq "Succeeded"
                $icon = if ($success) { "‚úÖ" } else { "‚ùå" }
                $status = if ($success) { "SUCCESS" } else { "FAILED" }
                
                $message = "$icon *KhulaFxAdmin API Deploy $status!*`n`n"
                $message += "üì¶ *Project:* KhulaFxAdmin (Backend)`n"
                $message += "üî¢ *Build:* $(Build.BuildNumber)`n"
                $message += "üë§ *By:* $(Build.RequestedFor)`n"
                $message += "üåø *Branch:* $(Build.SourceBranchName)`n"
                $message += "üí¨ *Commit:* $(Build.SourceVersionMessage)`n"
                
                if ($success) {
                  $message += "üåê *URL:* http://$(vpsServer)/api`n"
                }
                
                $duration = [math]::Round((New-TimeSpan -Start '$(System.PipelineStartTime)' -End (Get-Date)).TotalMinutes, 2)
                $message += "‚è±Ô∏è *Duration:* $duration minutes`n"
                $message += "üîó [View Logs](https://dev.azure.com/KhulaFx/KhulaFxTrade/_build/results?buildId=$(Build.BuildId))"
                
                $body = @{ chat_id = "$(TELEGRAM_CHAT_ID)"; text = $message; parse_mode = "Markdown" } | ConvertTo-Json
                
                try {
                  Invoke-RestMethod -Uri "https://api.telegram.org/bot$(TELEGRAM_BOT_TOKEN)/sendMessage" `
                    -Method Post -ContentType "application/json" -Body $body
                } catch { Write-Warning "Telegram failed: $_" }