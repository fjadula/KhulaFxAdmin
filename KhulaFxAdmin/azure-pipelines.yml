# ========================================================
# Azure DevOps Pipeline for KhulaFxAdmin
# Windows Service Deployment
# Depends on KhulaFxTradeMonitor.dll from Pipeline A
# ========================================================

trigger:
  branches:
    include:
      - master
      - main

variables:
  - group: Deployment-Secrets
  - name: buildConfiguration
    value: 'Release'
  - name: dotnetVersion
    value: '8.x'
  - name: serviceName
    value: 'KhulaFxAdmin'
  - name: deployPath
    value: 'C:\Services\KhulaFxAdmin'
  - name: vpsServer
    value: '108.181.161.170'

stages:
# ================================
# DOWNLOAD DLL STAGE
# ================================
- stage: DownloadDLL
  displayName: 'Download KhulaFxTradeMonitor DLL'
  jobs:
  - job: DownloadDLLJob
    pool:
      name: 'Default'
    steps:
    - task: DownloadPipelineArtifact@2
      displayName: 'Download KhulaFxTradeMonitor DLL from Pipeline A'
      inputs:
        buildType: 'specific'
        project: 'KhulaFxTrade'
        pipeline: fjadula.KhulaFxTradeMonitor
        buildVersionToDownload: 'latest'
        artifactName: 'KhulaFxTradeMonitorDLL'
        targetPath: '$(Build.SourcesDirectory)\libs'

    - task: PowerShell@2
      displayName: 'List downloaded DLL'
      inputs:
        targetType: inline
        script: |
          Get-ChildItem "$(Build.SourcesDirectory)\libs" -Recurse | ForEach-Object { Write-Host $_.FullName }

# ================================
# BUILD STAGE
# ================================
- stage: Build
  displayName: 'Build KhulaFxAdmin'
  dependsOn: DownloadDLL
  jobs:
  - job: BuildJob
    pool:
      name: 'Default'
    steps:
    - checkout: self
      fetchDepth: 1

    - task: UseDotNet@2
      displayName: 'Install .NET SDK 8.x'
      inputs:
        packageType: sdk
        version: $(dotnetVersion)

    # -----------------------------
    # Build the Admin project
    # -----------------------------
    - task: PowerShell@2
      displayName: 'Build .NET Project'
      inputs:
        targetType: inline
        script: |
          $dllPath = "$(Build.SourcesDirectory)\libs"
          Write-Host "Referencing external DLL from: $dllPath"
          
          # Ensure csproj references the DLL dynamically if needed
          dotnet build "$(Build.SourcesDirectory)\KhulaFxAdmin\KhulaFxAdmin.csproj" `
            -c $(buildConfiguration) `
            /p:ReferencePath="$dllPath"

    # -----------------------------
    # Publish artifact for VPS deployment
    # -----------------------------
    - task: PowerShell@2
      displayName: 'Publish .NET Project'
      inputs:
        targetType: inline
        script: |
          $publishFolder = "$(Build.ArtifactStagingDirectory)\admin"
          Write-Host "Publishing project to $publishFolder"

          dotnet publish "$(Build.SourcesDirectory)\KhulaFxAdmin\KhulaFxAdmin.csproj" `
            -c $(buildConfiguration) `
            -r win-x64 `
            --self-contained true `
            -o "$publishFolder"

          if (!(Test-Path $publishFolder)) {
            Write-Error "Publish folder not found: $publishFolder"
            exit 1
          }

    - task: PowerShell@2
      displayName: 'List files in artifact folder'
      inputs:
        targetType: inline
        script: |
          Get-ChildItem "$(Build.ArtifactStagingDirectory)\admin" -Recurse | ForEach-Object { Write-Host $_.FullName }

    - task: PublishBuildArtifacts@1
      displayName: 'Publish for VPS Deployment'
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)/admin'
        artifactName: 'KhulaFxAdmin'
        publishLocation: 'Container'

# ================================
# DEPLOY STAGE
# ================================
- stage: Deploy
  displayName: 'Deploy to VPS'
  dependsOn: Build
  jobs:
  - deployment: DeployService
    displayName: 'Deploy KhulaFxAdmin Service'
    environment: 'VPS-Production'
    pool:
      name: 'Default'
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: KhulaFxAdmin

          - task: PowerShell@2
            displayName: 'Deploy Service'
            inputs:
              targetType: inline
              script: |
                $server = "$(vpsServer)"
                $deployPath = "$(deployPath)"
                $serviceName = "$(serviceName)"
                $artifactPath = "$(Pipeline.Workspace)/KhulaFxAdmin"

                Write-Host "Deploying to: $deployPath"

                $secPass = ConvertTo-SecureString "$(DEPLOY_PASSWORD)" -AsPlainText -Force
                $cred = New-Object PSCredential ("$(deployUser)", $secPass)
                $session = New-PSSession -ComputerName $server -Credential $cred -Authentication Negotiate

                try {
                  # Stop service if running
                  Invoke-Command -Session $session -ScriptBlock {
                    param($svc)
                    $service = Get-Service -Name $svc -ErrorAction SilentlyContinue
                    if ($service -and $service.Status -eq 'Running') {
                      Stop-Service -Name $svc -Force
                      Start-Sleep -Seconds 5
                    }
                  } -ArgumentList $serviceName

                  # Prepare directory
                  Invoke-Command -Session $session -ScriptBlock {
                    param($path)
                    if (-not (Test-Path $path)) { New-Item -ItemType Directory -Path $path -Force | Out-Null }
                    Get-ChildItem -Path $path | Where-Object { $_.Name -notmatch 'log|backup' } | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
                  } -ArgumentList $deployPath

                  # Copy files
                  Copy-Item -Path "$artifactPath\*" -Destination $deployPath -ToSession $session -Recurse -Force

                  # Install/start service
                  Invoke-Command -Session $session -ScriptBlock {
                    param($svc, $path)
                    $exe = Get-ChildItem -Path $path -Filter "KhulaFxAdmin.exe" | Select-Object -First 1
                    if (-not $exe) { throw "Executable not found" }

                    $binaryPath = $exe.FullName
                    $service = Get-Service -Name $svc -ErrorAction SilentlyContinue
                    if ($service) {
                      sc.exe config $svc binPath= "`"$binaryPath`"" start= auto | Out-Null
                    } else {
                      New-Service -Name $svc -BinaryPathName $binaryPath -DisplayName "Khula FX Admin" -StartupType Automatic | Out-Null
                    }

                    Start-Service -Name $svc
                  } -ArgumentList $serviceName, $deployPath

                } finally {
                  Remove-PSSession $session
                }

# ================================
# NOTIFY STAGE
# ================================
- stage: Notify
  displayName: 'Send Deployment Notification'
  dependsOn: Deploy
  condition: always()
  jobs:
  - job: SendNotification
    pool:
      name: 'Default'
    steps:
    - task: PowerShell@2
      displayName: 'Telegram Notification'
      inputs:
        targetType: inline
        script: |
          $status = if ("$(Agent.JobStatus)" -eq "Succeeded") { "✅ SUCCESS" } else { "❌ FAILED" }
          $message = @"
          *KhulaFxAdmin Deployment*
          
          Status: $status
          Server: $(vpsServer)
          Path: $(deployPath)
          Build: $(Build.BuildNumber)
          "@

          $url = "https://api.telegram.org/bot$(TELEGRAM_BOT_TOKEN)/sendMessage"
          $body = @{ chat_id = "$(TELEGRAM_CHAT_ID)"; text = $message; parse_mode = "Markdown" } | ConvertTo-Json
          try { Invoke-RestMethod -Uri $url -Method Post -ContentType "application/json; charset=utf-8" -Body ([System.Text.Encoding]::UTF8.GetBytes($body)) } catch { Write-Warning "Notification failed" }
